
# REvil Analysis

## **Overview**

This report is my brief analysis for the **REvil Ransomware**.

In the analysis, I cover some **REvil** ransomware functionalities. 

## **IOCS**

The sample I used is a 32-bit Windows executable.  

**MD5**: fa8117afd2dbd20513522f2f8e991262



**SHA256**:
78b592a2710d81fa91235b445f674ee804db39c8cc34f7e894b4e7b7f6eacaff

**Sample**: 
https://bazaar.abuse.ch/sample/78b592a2710d81fa91235b445f674ee804db39c8cc34f7e894b4e7b7f6eacaff/


## **First stage** 
## **Static analysis** 

In the static analysis, I used the **Capa** open-source tool, which is used to identify malware/ransomware capabilities. The table shows all identified ATT&CK tactics and associated techniques, MBC (Malware Behavior Catalog) objectives and associated MBC behaviors, capabilities, and associated namespaces.
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240329164439.png]]
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240328115500.png]]

In the MBC Objective section - CRYPTOGRAPHY, we can see that the ransomware sample is using RC4 stream cipher to encrypt data. 


### RC4 encryption 

Based on the source https://en.wikipedia.org/wiki/RC4, there are 3 different main stages in RC4 encryption. 

##### Key-scheduling algorithm (KSA)
The first stage is the initialization stage, and it is responsible for creating and initializing the substitution box called as **SBox**. 
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240331210321.png]]

The second stage is scrambling, and it is responsible for scrambling SBox. 
*Note: the way to identify and detect RC4 encryption is by looking at the iteration number 256.*  
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240331210425.png]]

##### Pseudo-random generation algorithm (PRGA)
The third stage is responsible for creating a new SBox and encoding the data.    
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240331211015.png]]



Based on the **Detect it Easy** we can see that one of the sections in our ransomware sample is packed. We can assume that it is the first stage of ransomware.    
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240331212535.png]]



## **Code Analysis**

At the end of the entry point function, we can see the function **FUN_0040110b** with one argument **&local_14**. 
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240331214734.png]]


Inside the function **FUN_0040110b** there is a declaration of an array variable local_124 with 256 bytes of value. 
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240404134604.png]]

We can see the hex values, which I assume represents **RC4 key**.

To receive **RC4 key** from these hex values, I used **CyberChef** tool with the following recipe: 

![[../../../assets/images/malware-analysis/REvil/Pasted image 20240405135437.png]]

![[../../../assets/images/malware-analysis/REvil/Pasted image 20240405140236.png]]

*Note: In Ghidra disassembler, the string "**RC4 key**" is stored on a stack and is initialized directly from instructions. Therefore, it is split by 4 characters (or 8 on different platforms) and represented by a uint32 (or uint64) number. On x86, this number is stored in little-endian.*  



Another way, to obtain this **RC4 key** directly from Ghidra is to retype the earliest element (in this case local_24) from *undefined* to *char[n]* where *n* is the length of the reconstructed string (in this case 32).  

![[../../../assets/images/malware-analysis/REvil/Pasted image 20240405160303.png]]
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240405161831.png]]

![[../../../assets/images/malware-analysis/REvil/Pasted image 20240405162004.png]]
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240405162026.png]]

This technique is  **stackstrings** and is used to "hide'" strings from the malware analyst. 

In the output from **Capa** tool in **Capability** section, we can also see mention of this technique. 

![[../../../assets/images/malware-analysis/REvil/Pasted image 20240405155032.png]]



In comparison to **IDA** disassembler, I was able to obtain an immediate **RC4 key**. 
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240409161542.png]]



In the function **FUN_0040100e**, we can observe multiple loops that are similar to **PRGA** 
(Pseudo-random generation algorithm). 
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240409161352.png]]


In comparison to the **IDA** disassembler, we can observe a significant difference in the interpretation of pseudocode. 
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240409161514.png]]
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240331211015.png]]



In the function **FUN_004010a3**, we can observe a loop that is similar to **KSA** 
(Key-scheduling algorithm). 
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240410133110.png]]
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240409165056.png]]



In comparison to the **IDA** disassembler, we can also see differences in the interpretation of pseudocode. 
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240409165355.png]]

So, in combination with using multiple dissemblers, we can get different views on codes, which can bring us better understanding and effectiveness during the analysis.



In the function **FUN_004010a3**, we can see **DAT_00403000**, which is the encrypted portion of the ransomware sample. 
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240410134231.png]]
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240410134822.png]]

It is named "enc", which potentially represents "encrypted."  




## **Unpacking first stage**

I used the **PEBear** tool to extract the **enc** section and the **CyberChef** tool to decrypt the content of encrypted data by using the **RC4 key**, which I obtained in the **Code analysis - First stage** section .
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240410170045.png]]



In the output from **CyberChef** tool, we can see the magic number **MZ**, which is the executable file format used for .EXE files. 
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240410180040.png]]

I saved the output as **decrypted.bin**. 



## Second stage
## **Static analysis**

In the static analysis, I also used **Capa** open-source tool to check the capabilities of a second stage malicious sample.  

![[../../../assets/images/malware-analysis/REvil/Pasted image 20240415134600.png]]

-v as verbose 

![[../../../assets/images/malware-analysis/REvil/Pasted image 20240415135028.png]]
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240415134736.png]]

Based on these results from **Capa** tool, we can copy the addresses of **RC4 encryption** and identify them in Ghidra or IDA disassembler.



## **Code Analysis**

In Ghidra, we can go to the **Navigation** and select **Go To...** 
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240415135814.png]]
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240415135945.png]]
*Note: 0x4061B1 address for RC4 PRGA from Capa output.* 



The function **FUN_004061b1** is related to **RC4 PRGA** encryption.
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240415140348.png]]


There is one reference to the function **FUN_004061b1**, and it is the function **FUN_0040646a**. 
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240415143001.png]]
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240415145440.png]]


The function **FUN_00406159** is related to **RC4 KSA** encryption. 
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240415145159.png]]

The fact that the function **FUN_00406159** is related to **RC4 KSA** encryption can also be confirmed from **Capa** output. 
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240415145806.png]]


We can see that, there is an array with a value 256 bytes, **undefined local_104 [256]**, which can be represented as **Sbox**. 
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240415144006.png]]


In most cases, the **RC4_PRGA** function follows the **RC4_KSA** function right after.
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240415151005.png]]



Inside the **RC4_KSA** (FUN_00406159) function, we can see the function prologue, and then immediately we can see a single while loop that is looping through 256 times (0x100). 
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240415160045.png]]



 Next, we can see a loop counter *INC EAX*; it is initialised as zero *XOR ESI, ESI; MOV EAX, ESI*  
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240415160251.png]]



It is stored in an array of *EDI* which is **Sbox**.
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240415161952.png]]


*param_1* represents Sbox; *param_2* represents RC4 key; *param_3* represents key length.  
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240417144251.png]]


Next, we can see the second loop with another 0x100 constant and *DIV* which is one of the most frequent ways to see the *mod* operator in assembly, which can give more confidence that it is **RC4 encryption**.

![[../../../assets/images/malware-analysis/REvil/Pasted image 20240415193809.png]]



The reference to the function **FUN_0040646a**, which contains the functions related to RC4 encryption **RC4_KSA** (FUN_00406159) and **RC4 PRGA** (FUN_004061b1), is **FUN_00401bd8**.
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240422165628.png]]



The function **FUN_0040646a** is receiving multiply arguments, where the first argument (0x412000) is a RC4 key, the second argument (0x20 - 32 DEC) is a RC4 key length, the third argument (0x412028) is encrypted data, the fourth argument (DAT_00412024) is the length of encrypted data, and the fifth argument (pbVar2) is the result. 


**RC4 key**: ME66owJbm4dzYUuAjkZHaRe4mRQp9TFI
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240423110947.png]]


**RC4 key length**
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240423112030.png]]



**Encrypted data**
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240423111220.png]]


**Length of encrypted data**
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240423114533.png]]
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240423114642.png]]
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240423114807.png]]


As we can see in the picture above, I took the **RC4 key** and decrypted the configuration file inside the ransomware sample by using **CyberChef** tool. 


The configuration structure is stored in JSON and contains 18 keys. 
![[../../../assets/images/malware-analysis/REvil/carbon.png]]


pk -> The public key for the cryptographic process; the public key of the attacker, used by ransomware to perform encryption. 

pid -> The affiliate number that belongs to the sample.

sub -> The campaign ID for this sample that the affiliate uses to keep track of its payments.

dbg -> Debug option; it is a development option that can be true or false. In the samples in the wild, it is in a false state. It is useful for the malware developers to prove the malware works correctly without detecting their own machines based on the language.

et -> encryption type
	0 - Encrypt all data in a file
	1 - Encrypt only the first MB of a file.
	2 - Encrypt 1 MB then skip the next MBs specified by the spsize field.

spsize -> The number of MBs to skip when et is set to 2

wipe -> If this option is "true," the malware will destroy the target files in the folders that are described in the json field “wfld.” This destruction happens in all folders that have the name or names that appear in this field of the config in logic units and network shares. The overwriting of the files can be with trash data or null data, depending on the sample.

wfld -> A list of folders where the files will be destroyed if the wipe option is enabled.

wht -> This field has some subfields: fld -> folders that should not be crypted; they are whitelisted to avoid destroying critical files in the system and programs. fls -> List of whitelists of files per name; these files will never be crypted, and this is useful to avoid destroying critical files in the system. ext -> List of the target extensions to avoid encrypting based on extension.

prc -> List of processes to kill for unlocking files that are locked by this/these program/s. 

svc -> List of services to close and delete

dmn -> List of C2 domains

net -> This value can be false or true. By default, it is usually true, meaning that the malware will send information about the victim if they have Internet access to the domain list in the field “dmn” in the config.

exp -> Whether or not to attempt running the application with Administrator privileges, a flag to local privilege escalation

arn -> Whether or not to set a registry key to have the application run on startup, a persistence flag. 

nbody -> A string encoded in base64 that is the template for the ransom note that will appear in each folder where the malware can create it.

nname -> The string of the name of the malware for the ransom note file. 

img -> A string encoded in base64. It is the template for the image that the malware will create in runtime to change the wallpaper of the desktop with this text.



The content of the "README.txt" - nbody key from the configuration file in base64
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240424173333.png]]



 The template for the image that the malware will create in runtime to change the wallpaper of the desktop with this text in base64 
![[../../../assets/images/malware-analysis/REvil/Pasted image 20240424175302.png]]




## **References** 

https://blog.talosintelligence.com/an-introduction-to-recognizing-and/
https://www.tripwire.com/state-of-security/ghidra-101-decoding-stack-strings
https://www.reddit.com/r/ghidra/comments/18t5jy0/help_with_ghidra_converting_hex_constant_to/
https://www.trellix.com/blogs/research/mcafee-atr-analyzes-sodinokibi-aka-revil-ransomware-as-a-service-what-the-code-tells-us/
https://blog.qualys.com/vulnerabilities-threat-research/2021/07/07/analyzing-the-revil-ransomware-attack
https://malware.news/t/sodinokibi-ransomware-analysis/48721
